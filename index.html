<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Vice Details</title>

<link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

<style>
html,body{margin:0;height:100%;font-family:'Arial Rounded MT Bold',system-ui}
#map{position:absolute;inset:0}

.hud{
 position:absolute;top:12px;left:12px;z-index:10;
 width:230px;padding:10px;border-radius:18px;
 background:linear-gradient(135deg,rgba(255,90,200,.85),rgba(120,200,255,.85));
 backdrop-filter:blur(12px);
 box-shadow:0 10px 30px rgba(0,0,0,.35);
 color:#1b0022;font-size:12px
}
.hud h1{margin:0 0 6px;font-size:18px;letter-spacing:.15em}
.hud button{
 width:100%;margin-top:6px;padding:8px;border:0;border-radius:10px;
 background:#ff3dbb;color:#140015;font-weight:800
}
.hud button.alt{background:rgba(255,255,255,.35)}
.small{font-size:11px;opacity:.9}
@media(max-width:480px){
 .hud{width:190px;padding:8px;font-size:11px}
 .hud h1{font-size:15px}
}
</style>
</head>

<body>
<div id="map"></div>

<div class="hud">
<h1>VICE DETAILS</h1>
<div id="coords" class="small">Tap Start GPS</div>
<div id="route" class="small" style="display:none"></div>
<button id="gps">Start GPS</button>
<button class="alt" id="clearWp">Clear waypoint</button>
<button class="alt" id="setHome">Set Home (GPS)</button>
<button class="alt" id="pickHome">Pick Home on map</button>
<button class="alt" id="clearHome">Clear Home</button>
<button class="alt" id="reset">Reset / Clear all</button>
<div class="small" style="margin-top:6px">
• Tap map to set waypoint<br>
• Purple line follows roads<br>
• POIs load automatically
</div>
<div class="small" style="opacity:.5;margin-top:6px">
© OpenStreetMap • CARTO • OSRM
</div>
</div>

<script>
const map=new maplibregl.Map({
 container:'map',
 style:{
  version:8,
  sources:{
   carto:{
    type:'raster',
    tiles:[
     'https://a.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png',
     'https://b.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png'
    ],
    tileSize:256
   }
  },
  layers:[{id:'base',type:'raster',source:'carto'}]
 },
 center:[10.75,59.91],
 zoom:13
});

map.on('load',()=>{
 map.addSource('route',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
 map.addLayer({
  id:'routeLine',
  type:'line',
  source:'route',
  paint:{'line-width':6,'line-color':'#a855f7'}
 });
});

let watch=null,user=null,marker=null,wp=null,home=null,homePick=false;

const coordsEl=document.getElementById('coords');
const routeEl=document.getElementById('route');

document.getElementById('gps').onclick=()=>{
 if(watch){navigator.geolocation.clearWatch(watch);watch=null;coordsEl.textContent='GPS stopped';return;}
 navigator.geolocation.getCurrentPosition(p=>centerUser(p));
 watch=navigator.geolocation.watchPosition(p=>centerUser(p));
};

function centerUser(p){
 user=[p.coords.longitude,p.coords.latitude];
 coordsEl.textContent=`You: ${user[1].toFixed(5)}, ${user[0].toFixed(5)}`;
 if(!marker){
  marker=new maplibregl.Marker().setLngLat(user).addTo(map);
  map.flyTo({center:user,zoom:16});
 }else marker.setLngLat(user);
}

map.on('click',e=>{
 if(homePick){
  setHome([e.lngLat.lng,e.lngLat.lat]);
  homePick=false;
  return;
 }
 setWaypoint([e.lngLat.lng,e.lngLat.lat]);
});

function setWaypoint(ll){
 wp=ll;
 drawRoute();
 new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg').play();
}

function setHome(ll){
 home=ll;
 localStorage.setItem('home',JSON.stringify(ll));
 new maplibregl.Marker({color:'#000'}).setLngLat(ll).addTo(map);
 new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg').play();
}

document.getElementById('setHome').onclick=()=>{if(user)setHome(user)};
document.getElementById('pickHome').onclick=()=>homePick=true;
document.getElementById('clearHome').onclick=()=>{home=null;localStorage.removeItem('home')};
document.getElementById('clearWp').onclick=()=>{wp=null;routeEl.style.display='none';map.getSource('route').setData({type:'FeatureCollection',features:[]})};
document.getElementById('reset').onclick=()=>{wp=null;home=null;localStorage.clear();location.reload()};

async function drawRoute(){
 if(!user||!wp)return;
 const url=`https://router.project-osrm.org/route/v1/walking/${user[0]},${user[1]};${wp[0]},${wp[1]}?overview=full&geometries=geojson`;
 const r=await fetch(url).then(r=>r.json());
 const g=r.routes[0].geometry;
 map.getSource('route').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:g}]});
 routeEl.style.display='block';
 routeEl.textContent=`~${Math.round(r.routes[0].duration/60)} min • ${(r.routes[0].distance/1000).toFixed(2)} km`;
}

const savedHome=localStorage.getItem('home');
if(savedHome)setHome(JSON.parse(savedHome));
</script>
</body>
</html>
