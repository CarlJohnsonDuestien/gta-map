<!doctype html>
<html lang="no">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GTA-ish Map</title>

<link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

<style>
html,body{margin:0;height:100%}
#map{width:100%;height:100%}

/* GTA-ish HUD */
.hud{
 position:absolute;top:12px;left:12px;z-index:10;
 background:rgba(0,0,0,.55);
 color:#fff;
 padding:10px 12px;
 border-radius:10px;
 font-family:system-ui,Arial;
 font-size:12px;
 width:210px;
 backdrop-filter:blur(6px)
}
.hud b{font-size:18px;display:block;margin-bottom:4px}
.hud button{
 width:100%;margin-top:6px;
 padding:7px;border:0;border-radius:8px;
 font-weight:700;cursor:pointer
}
.btn-main{background:#eee;color:#111}
.btn-alt{background:#ffffff22;color:#fff;border:1px solid #ffffff33}

/* MARKERS */
.marker{width:26px;height:26px}
.marker svg{width:100%;height:100%}
</style>
</head>

<body>
<div id="map"></div>

<div class="hud">
<b>GTA-ish Map</b>
<div id="status">Trykk Start GPS</div>
<button id="gps" class="btn-main">Start GPS</button>
<button id="clear" class="btn-alt">Clear waypoint</button>
<div style="opacity:.7;margin-top:6px">
• Trykk på kartet for waypoint<br>
• POI lastes når du zoomer inn
</div>
</div>

<script>
const map=new maplibregl.Map({
 container:"map",
 style:{
  version:8,
  sources:{
   base:{
    type:"raster",
    tiles:[
     "https://a.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png",
     "https://b.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png"
    ],
    tileSize:256
   }
  },
  layers:[{id:"base",type:"raster",source:"base"}]
 },
 center:[10.75,59.91],
 zoom:13
})

let user=null, userMarker=null, waypoint=null, routeAt=0
const status=document.getElementById("status")

function icon(type){
 const paths={
  user:"M13 2 L23 22 L13 17 L3 22 Z",
  waypoint:"M15 4 L18 12 L26 15 L18 18 L15 26 L12 18 L4 15 L12 12 Z",
  food:"M6 6h18v18H6z",
  clothes:"M8 6l7-3 7 3 2 4-3 2v12H11V12l-3-2z",
  fuel:"M9 6h12v18H9z",
  parking:"M10 6h7a6 6 0 010 12h-7z",
  bank:"M5 10h20v14H5zM5 10l10-5 10 5",
  police:"M15 4l10 4v7c0 6-5 10-10 11-5-1-10-5-10-11V8z",
  hospital:"M13 6h4v6h6v4h-6v6h-4v-6H7v-4h6z",
  hotel:"M6 8h8v14H6zM16 12h8v10h-8z"
 }
 const el=document.createElement("div")
 el.className="marker"
 el.innerHTML=`
 <svg viewBox="0 0 30 30">
 <path d="${paths[type]}" fill="#fff" stroke="#000" stroke-width="2"/>
 </svg>`
 return el
}

/* GPS */
document.getElementById("gps").onclick=()=>{
 navigator.geolocation.watchPosition(p=>{
  user=[p.coords.longitude,p.coords.latitude]
  status.textContent=`Du er her`
  if(!userMarker){
   userMarker=new maplibregl.Marker({element:icon("user")})
    .setLngLat(user).addTo(map)
   map.flyTo({center:user,zoom:16})
  }else userMarker.setLngLat(user)
 })
}

/* Waypoint */
map.on("click",e=>{
 if(!user)return
 if(!waypoint){
  waypoint=new maplibregl.Marker({element:icon("waypoint")})
   .setLngLat(e.lngLat).addTo(map)
 }else waypoint.setLngLat(e.lngLat)
})

/* POI */
async function loadPOI(){
 if(map.getZoom()<14||!user)return
 const b=map.getBounds()
 const q=`
[out:json];
(
 node["amenity"="fast_food"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
 node["amenity"="nightclub"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
 node["shop"="supermarket"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
 node["shop"="convenience"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
 node["shop"="clothes"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
 node["amenity"="fuel"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
 node["amenity"="parking"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
 node["amenity"="bank"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
 node["amenity"="atm"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
 node["amenity"="police"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
 node["amenity"="hospital"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
 node["tourism"="hotel"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
);
out 40;
`
 const res=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:q})
 const data=await res.json()
 data.elements.forEach(e=>{
  if(!e.tags||!e.tags.name)return
  const t=e.tags
  let type="food"
  if(t.shop==="clothes")type="clothes"
  if(t.amenity==="fuel")type="fuel"
  if(t.amenity==="parking")type="parking"
  if(t.amenity==="bank"||t.amenity==="atm")type="bank"
  if(t.amenity==="police")type="police"
  if(t.amenity==="hospital")type="hospital"
  if(t.tourism==="hotel")type="hotel"
  new maplibregl.Marker({element:icon(type)})
   .setLngLat([e.lon,e.lat]).addTo(map)
 })
}

map.on("moveend",loadPOI)
</script>
</body>
</html>
