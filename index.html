<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GTA-ish Map</title>

  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .hud{
      position:absolute; top:12px; left:12px; z-index:10;
      background:rgba(0,0,0,.55); color:#fff;
      padding:10px 12px; border-radius:10px;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size:12px; width:240px;
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .hud .title{ font-weight:900; font-size:16px; margin-bottom:6px; }
    .hud button{
      width:100%; margin-top:6px; padding:8px 10px;
      border:0; border-radius:8px; cursor:pointer;
      font-weight:900; font-size:13px;
    }
    .btn-main{ background:#eee; color:#111; }
    .btn-alt{ background:rgba(255,255,255,0.12); color:#fff; border:1px solid rgba(255,255,255,0.18); }
    .hint{ margin-top:8px; opacity:.82; line-height:1.35; }
    .small{ margin-top:6px; opacity:.85; font-size:12px; }
    .attrib{ margin-top:10px; opacity:.65; font-size:11px; }

    .marker-wrap { display:grid; place-items:center; user-select:none; }
    .shadow { filter: drop-shadow(0 2px 2px rgba(0,0,0,0.55)); }

    .poi { width:26px; height:26px; }
    .userpin { width:26px; height:26px; }
    .waypoint { width:34px; height:34px; }

    .poi-img{
      width:100%;
      height:100%;
      object-fit:contain;
      image-rendering:auto;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="hud">
    <div class="title">GTA-ish Map</div>
    <div id="status">Trykk Start GPS</div>

    <button id="gpsBtn" class="btn-main">Start GPS</button>
    <button id="clearBtn" class="btn-alt">Clear waypoint</button>

    <div class="hint">
      • Trykk på kartet for waypoint<br>
      • Lilla linje følger veiene (ingen navigasjon)<br>
      • POI lastes når du zoomer inn (14+)
    </div>

    <div id="poiStatus" class="small">POI: zoom inn (14+)…</div>

    <div class="attrib">© OpenStreetMap contributors • Basemap © CARTO • Routing: OSRM</div>
  </div>

<script>
  // -----------------------
  // EXACT icons you sent (real base64)
  // -----------------------
  const ICONS = {
    nightclub: "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxAQEA8QDw8PDw8PDw8PDw8PDw8PFREWFhURFRUYHSggGBolGxUVITEhJSkrLi4uFx8zODMsNygtLisBCgoKDg0OGhAQGi0lHyUtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLf/AABEIAEAAQAMBIgACEQEDEQH/xAAbAAEAAgMBAQAAAAAAAAAAAAAABQYBBAcDAv/EAD4QAAIBAgQDBgQEBQUAAAAAAAECAwQRAAUSITFBBhMiUWFxgZGhMkJSsdHh8BMzQqLwI2LxFRYkU4PS/8QAGQEBAAMBAQAAAAAAAAAAAAAAAAECAwQF/8QAJxEBAAICAgICAgMAAAAAAAAAAAECAxEhBBIxQQUTImFxgZGhscH/2gAMAwEAAhEDEQA/APVKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//Z",

    store_fuel_convenience_supermarket: "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxAQEA8QDw8PDw8PDw8PDw8PDw8PFREWFhURFRUYHSggGBolGxUVITEhJSkrLi4uFx8zODMsNygtLisBCgoKDg0OGhAQGi0lHyUtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLf/AABEIAEAAQAMBIgACEQEDEQH/xAAbAAEAAgMBAQAAAAAAAAAAAAAABQYBBAcDAv/EADoQAAIBAgQDBgQEBQUAAAAAAAECAwQRAAUSITFBBhMiUWFxgZGhMkJSsdHh8BMzQqLwI2LxFRYkU4PS/8QAGQEBAAMBAQAAAAAAAAAAAAAAAAECAwQF/8QAJxEBAAICAgICAgMAAAAAAAAAAAECAxEhBBIxQQUTImFxgZGhscH/2gAMAwEAAhEDEQA/APVKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//Z",

    clothes: "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxAQEA8QDw8PDw8PDw8PDw8PDw8PFREWFhURFRUYHSggGBolGxUVITEhJSkrLi4uFx8zODMsNygtLisBCgoKDg0OGhAQGi0lHyUtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLf/AABEIAEAAQAMBIgACEQEDEQH/xAAbAAEAAgMBAQAAAAAAAAAAAAAABQYBBAcDAv/EADoQAAIBAgQDBgQEBQUAAAAAAAECAwQRAAUSITFBBhMiUWFxgZGhMkJSsdHh8BMzQqLwI2LxFRYkU4PS/8QAGQEBAAMBAQAAAAAAAAAAAAAAAAECAwQF/8QAJxEBAAICAgICAgMAAAAAAAAAAAECAxEhBBIxQQUTImFxgZGhscH/2gAMAwEAAhEDEQA/APVKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//Z",

    hospital: "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxAQEA8QEA8QDw8PDw8PDw8PDw8PDw8PFREWFhURFRUYHSggGBolGxUVITEhJSkrLi4uFx8zODMsNygtLisBCgoKDg0OGhAQGi0lHyUtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLf/AABEIAOEA4QMBIgACEQEDEQH/xAAbAAABBQEBAAAAAAAAAAAAAAAEAAIDBQYBB//EADwQAAIBAgQDBgQEBQUAAAAAAAECAwQRAAUSITFBBhMiUWFxgZGhMkJSsdHh8BMzQqLwI2LxFRYkU4PS/8QAGQEBAAMBAQAAAAAAAAAAAAAAAAECAwQF/8QAJxEBAAICAgICAgMAAAAAAAAAAAECAxEhBBIxQQUTImFxgZGhscH/2gAMAwEAAhEDEQA/APqkqKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//Z",

    parking: "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxAQEA8QDw8PDw8PDw8PDw8PDw8PFREWFhURFRUYHSggGBolGxUVITEhJSkrLi4uFx8zODMsNygtLisBCgoKDg0OGhAQGi0lHyUtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLf/AABEIAEAAQAMBIgACEQEDEQH/xAAbAAEAAgMBAQAAAAAAAAAAAAAABQYBBAcDAv/EADoQAAIBAgQDBgQEBQUAAAAAAAECAwQRAAUSITFBBhMiUWFxgZGhMkJSsdHh8BMzQqLwI2LxFRYkU4PS/8QAGQEBAAMBAQAAAAAAAAAAAAAAAAECAwQF/8QAJxEBAAICAgICAgMAAAAAAAAAAAECAxEhBBIxQQUTImFxgZGhscH/2gAMAwEAAhEDEQA/APVKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//Z",

    police: "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxAQEA8QEA8QDw8PDw8PDw8PDw8PDw8PFREWFhURFRUYHSggGBolGxUVITEhJSkrLi4uFx8zODMsNygtLisBCgoKDg0OGhAQGi0lHyUtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLf/AABEIAOEA4QMBIgACEQEDEQH/xAAbAAACAwEBAQAAAAAAAAAAAAAEBQADBgIBB//EAD0QAAIBAgQDBgQEBQQDAAAAAAECAwQRAAUSITFBBhMiUWFxgZGhMkJSsdHh8BMzQqLwI2LxFRYkU4PS/8QAGQEBAAMBAQAAAAAAAAAAAAAAAAECAwQF/8QAJxEBAAICAgICAgMAAAAAAAAAAAECAxEhBBIxQQUTImFxgZGhscH/2gAMAwEAAhEDEQA/APqkqKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//Z",

    fast_food: "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxAQEA8QEA8QDw8PDw8PDw8PDw8PDw8PFREWFhURFRUYHSggGBolGxUVITEhJSkrLi4uFx8zODMsNygtLisBCgoKDg0OGhAQGi0lHyUtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLf/AABEIAOEA4QMBIgACEQEDEQH/xAAbAAABBQEBAAAAAAAAAAAAAAAEAAIDBQYBB//EADoQAAIBAgQDBgQEBQUAAAAAAAECAwQRAAUSITFBBhMiUWFxgZGhMkJSsdHh8BMzQqLwI2LxFRYkU4PS/8QAGQEBAAMBAQAAAAAAAAAAAAAAAAECAwQF/8QAJxEBAAICAgICAgMAAAAAAAAAAAECAxEhBBIxQQUTImFxgZGhscH/2gAMAwEAAhEDEQA/APqkqKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//Z",

    bank: "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxAQEA8QEA8QDw8PDw8PDw8PDw8PDw8PFREWFhURFRUYHSggGBolGxUVITEhJSkrLi4uFx8zODMsNygtLisBCgoKDg0OGhAQGi0lHyUtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLf/AABEIAEAAQAMBIgACEQEDEQH/xAAbAAEAAgMBAQAAAAAAAAAAAAAABQYBBAcDAv/EADoQAAIBAgQDBgQEBQUAAAAAAAECAwQRAAUSITFBBhMiUWFxgZGhMkJSsdHh8BMzQqLwI2LxFRYkU4PS/8QAGQEBAAMBAQAAAAAAAAAAAAAAAAECAwQF/8QAJxEBAAICAgICAgMAAAAAAAAAAAECAxEhBBIxQQUTImFxgZGhscH/2gAMAwEAAhEDEQA/APVKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//Z"
  };

  // -----------------------
  // Marker helpers
  // -----------------------
  function wrapEl(el, cls){
    const d = document.createElement("div");
    d.className = `marker-wrap shadow ${cls}`;
    d.appendChild(el);
    return d;
  }

  function createImgMarker(dataUri, cls){
    const img = document.createElement("img");
    img.className = "poi-img";
    img.src = dataUri;
    img.alt = "";
    return wrapEl(img, cls);
  }

  // Keep your user + waypoint:
  function createUserArrowEl(){
    const el = document.createElement('div');
    el.className = 'marker-wrap shadow userpin';
    el.innerHTML = `
      <svg width="26" height="26" viewBox="0 0 26 26" aria-hidden="true">
        <path d="M13 2 L23 22 L13 17.4 L3 22 Z" fill="#ffffff"/>
        <path d="M13 2 L23 22 L13 17.4 L3 22 Z" fill="none" stroke="rgba(0,0,0,0.55)" stroke-width="1.2"/>
      </svg>
    `;
    return el;
  }

  function createWaypointEl(){
    const el = document.createElement('div');
    el.className = 'marker-wrap shadow waypoint';
    el.innerHTML = `
      <svg width="34" height="34" viewBox="0 0 30 30" aria-hidden="true">
        <g fill="none" stroke="#a855f7" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M15 7 C12.2 7,10 9.2,10 12 C10 14.8,12.2 17,15 17 C17.8 17,20 14.8,20 12 C20 9.2,17.8 7,15 7Z"/>
          <path d="M15 13 C12.2 13,10 15.2,10 18 C10 20.8,12.2 23,15 23 C17.8 23,20 20.8,20 18 C20 15.2,17.8 13,15 13Z"/>
          <path d="M7 15 C7 12.2,9.2 10,12 10 C14.8 10,17 12.2,17 15 C17 17.8,14.8 20,12 20 C9.2 20,7 17.8,7 15Z"/>
          <path d="M13 15 C13 12.2,15.2 10,18 10 C20.8 10,23 12.2,23 15 C23 17.8,20.8 20,18 20 C15.2 20,13 17.8,13 15Z"/>
          <circle cx="15" cy="15" r="2.2" />
        </g>
      </svg>
    `;
    return el;
  }

  // -----------------------
  // Map
  // -----------------------
  const map = new maplibregl.Map({
    container: "map",
    style: {
      version: 8,
      sources: {
        base: {
          type: "raster",
          tiles: [
            "https://a.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png",
            "https://b.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png",
            "https://c.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png",
            "https://d.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png"
          ],
          tileSize: 256,
          attribution: "© OpenStreetMap contributors © CARTO"
        }
      },
      layers: [{ id: "base", type: "raster", source: "base" }]
    },
    center: [10.75, 59.91],
    zoom: 13
  });

  map.on("load", () => {
    map.addSource("route", { type:"geojson", data:{ type:"FeatureCollection", features:[] } });

    map.addLayer({
      id:"route-glow",
      type:"line",
      source:"route",
      paint:{ "line-width":12, "line-opacity":0.22, "line-color":"#a855f7" }
    });

    map.addLayer({
      id:"route-line",
      type:"line",
      source:"route",
      paint:{ "line-width":6, "line-opacity":0.92, "line-color":"#a855f7" }
    });

    map.on("moveend", schedulePOILoad);
  });

  // -----------------------
  // UI state
  // -----------------------
  const statusEl = document.getElementById("status");
  const poiStatusEl = document.getElementById("poiStatus");
  const gpsBtn = document.getElementById("gpsBtn");
  const clearBtn = document.getElementById("clearBtn");

  let watchId = null;
  let userLngLat = null;
  let userMarker = null;
  let userEl = null;

  let destMarker = null;
  let destLngLat = null;
  let lastRouteAt = 0;

  const poiMarkers = new Map(); // id -> marker
  let poiFetchTimer = null;
  let poiAbort = null;

  function setStatus(t){ statusEl.textContent = t; }
  function setPOIStatus(t){ poiStatusEl.textContent = t; }

  function clearRouteAndWaypoint(){
    destLngLat = null;
    if(destMarker){ destMarker.remove(); destMarker = null; }
    const src = map.getSource("route");
    if(src) src.setData({ type:"FeatureCollection", features:[] });
    setStatus("Waypoint fjernet.");
  }
  clearBtn.addEventListener("click", clearRouteAndWaypoint);

  // GPS toggle
  gpsBtn.addEventListener("click", () => {
    if(!navigator.geolocation){
      setStatus("GPS støttes ikke.");
      return;
    }

    if(watchId !== null){
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
      gpsBtn.textContent = "Start GPS";
      setStatus("GPS stoppet.");
      return;
    }

    gpsBtn.textContent = "Stop GPS";
    setStatus("Ber om posisjon…");

    watchId = navigator.geolocation.watchPosition(
      (pos) => {
        const lng = pos.coords.longitude;
        const lat = pos.coords.latitude;
        userLngLat = [lng, lat];

        const heading = (typeof pos.coords.heading === 'number' && !Number.isNaN(pos.coords.heading))
          ? pos.coords.heading : null;

        setStatus(`Du er her: ${lat.toFixed(5)}, ${lng.toFixed(5)}`);

        if(!userMarker){
          userEl = createUserArrowEl();
          userMarker = new maplibregl.Marker({ element: userEl })
            .setLngLat(userLngLat)
            .addTo(map);
          map.flyTo({ center: userLngLat, zoom: 16 });
        } else {
          userMarker.setLngLat(userLngLat);
        }

        if(userEl && heading !== null){
          userEl.style.transform = `rotate(${heading}deg)`;
        }

        if(destLngLat) drawRouteTo(destLngLat, true);
        schedulePOILoad();
      },
      (err) => {
        setStatus("GPS-feil: " + err.message);
        gpsBtn.textContent = "Start GPS";
        watchId = null;
      },
      { enableHighAccuracy: true, maximumAge: 1200, timeout: 10000 }
    );
  });

  // Waypoint on click
  map.on("click", (e) => {
    const ll = [e.lngLat.lng, e.lngLat.lat];
    destLngLat = ll;

    if(!destMarker){
      destMarker = new maplibregl.Marker({ element: createWaypointEl() })
        .setLngLat(ll)
        .addTo(map);
    } else {
      destMarker.setLngLat(ll);
    }

    drawRouteTo(ll, false);
  });

  async function drawRouteTo(dest, isAuto=false){
    if(!userLngLat){ setStatus("Start GPS først."); return; }

    const now = Date.now();
    const minGap = isAuto ? 2500 : 900;
    if(now - lastRouteAt < minGap) return;
    lastRouteAt = now;

    const [uLng,uLat] = userLngLat;
    const [dLng,dLat] = dest;

    const url =
      `https://router.project-osrm.org/route/v1/walking/` +
      `${uLng},${uLat};${dLng},${dLat}` +
      `?overview=full&geometries=geojson`;

    try{
      const res = await fetch(url);
      const data = await res.json();
      if(!data.routes || !data.routes[0]){
        if(!isAuto) setStatus("Fant ingen rute.");
        return;
      }

      const route = data.routes[0].geometry;
      const fc = { type:"FeatureCollection", features:[{ type:"Feature", properties:{}, geometry:route }] };
      const src = map.getSource("route");
      if(src) src.setData(fc);

      if(!isAuto){
        const distM = data.routes[0].distance;
        const mins = Math.max(1, Math.round(data.routes[0].duration / 60));
        setStatus(`Waypoint satt. ~${mins} min • ${(distM/1000).toFixed(2)} km`);
      }
    } catch(e){
      if(!isAuto) setStatus("Rute-feil.");
    }
  }

  // POI loading
  function schedulePOILoad(){
    if(poiFetchTimer) clearTimeout(poiFetchTimer);
    poiFetchTimer = setTimeout(loadPOIsInView, 900);
  }

  function bbox(){
    const b = map.getBounds();
    return [b.getSouth(), b.getWest(), b.getNorth(), b.getEast()];
  }

  function overpassQuery([s,w,n,e]){
    return `
[out:json][timeout:20];
(
  node["amenity"="fast_food"](${s},${w},${n},${e});
  node["amenity"="nightclub"](${s},${w},${n},${e});

  node["shop"="supermarket"](${s},${w},${n},${e});
  node["shop"="convenience"](${s},${w},${n},${e});
  node["amenity"="fuel"](${s},${w},${n},${e});

  node["shop"="clothes"](${s},${w},${n},${e});
  node["amenity"="hospital"](${s},${w},${n},${e});
  node["amenity"="parking"](${s},${w},${n},${e});
  node["amenity"="police"](${s},${w},${n},${e});

  node["amenity"="bank"](${s},${w},${n},${e});
  node["amenity"="atm"](${s},${w},${n},${e});
);
out body 500;
`;
  }

  function haversineMeters(a, b){
    const toRad = x => x*Math.PI/180;
    const R = 6371000;
    const dLat = toRad(b[1]-a[1]);
    const dLon = toRad(b[0]-a[0]);
    const lat1 = toRad(a[1]);
    const lat2 = toRad(b[1]);
    const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.min(1, Math.sqrt(h)));
  }

  function poiKind(tags){
    if(tags.amenity === "fast_food") return "fast_food";
    if(tags.amenity === "nightclub") return "nightclub";

    if(tags.shop === "supermarket") return "store_fuel_convenience_supermarket";
    if(tags.shop === "convenience") return "store_fuel_convenience_supermarket";
    if(tags.amenity === "fuel") return "store_fuel_convenience_supermarket";

    if(tags.shop === "clothes") return "clothes";
    if(tags.amenity === "hospital") return "hospital";
    if(tags.amenity === "parking") return "parking";
    if(tags.amenity === "police") return "police";

    if(tags.amenity === "bank") return "bank";
    if(tags.amenity === "atm") return "bank";

    return null;
  }

  function labelFromKind(k){
    return ({
      fast_food:"Fast food",
      nightclub:"Nightclub",
      store_fuel_convenience_supermarket:"Store/Fuel/Convenience",
      clothes:"Clothes",
      hospital:"Hospital",
      parking:"Parking",
      police:"Police",
      bank:"Bank/ATM"
    })[k] || "POI";
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  async function loadPOIsInView(){
    if(map.getZoom() < 14){
      setPOIStatus("POI: zoom inn (14+)…");
      return;
    }
    if(!userLngLat){
      setPOIStatus("POI: start GPS for best resultat.");
      return;
    }

    if(poiAbort) poiAbort.abort();
    poiAbort = new AbortController();

    setPOIStatus("POI: laster…");

    try{
      const q = overpassQuery(bbox());
      const res = await fetch("https://overpass-api.de/api/interpreter", {
        method:"POST",
        body:q,
        signal: poiAbort.signal,
        headers: { "Content-Type":"text/plain;charset=UTF-8" }
      });

      if(!res.ok){
        setPOIStatus("POI: feil/rate limit.");
        return;
      }

      const data = await res.json();
      const elements = Array.isArray(data.elements) ? data.elements : [];

      let filtered = elements
        .filter(el => el && el.tags && (el.tags.name || el.tags.brand))
        .map(el => {
          const k = poiKind(el.tags);
          return k ? { el, k } : null;
        })
        .filter(Boolean)
        .map(x => ({ ...x, dist: haversineMeters(userLngLat, [x.el.lon, x.el.lat]) }))
        .sort((a,b) => a.dist - b.dist);

      const MAX_POI = 45;
      filtered = filtered.slice(0, MAX_POI);

      const seen = new Set(filtered.map(x => `n${x.el.id}`));

      for(const [id, marker] of poiMarkers.entries()){
        if(!seen.has(id)){
          marker.remove();
          poiMarkers.delete(id);
        }
      }

      for(const item of filtered){
        const el = item.el;
        const id = `n${el.id}`;
        if(poiMarkers.has(id)) continue;

        const name = el.tags.name || el.tags.brand || "(uten navn)";
        const k = item.k;

        const markerEl = createImgMarker(ICONS[k], "poi");
        const m = new maplibregl.Marker({ element: markerEl })
          .setLngLat([el.lon, el.lat])
          .addTo(map);

        m.getElement().addEventListener("click", (ev) => {
          ev.stopPropagation();
          new maplibregl.Popup({ closeButton:true, closeOnClick:true })
            .setLngLat([el.lon, el.lat])
            .setHTML(`
              <div style="font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;font-size:13px">
                <div style="font-weight:900;margin-bottom:4px">${escapeHtml(name)}</div>
                <div style="opacity:.75">${escapeHtml(labelFromKind(k))}</div>
              </div>
            `)
            .addTo(map);
        });

        poiMarkers.set(id, m);
      }

      setPOIStatus(`POI: viser ${filtered.length} (nærmest deg).`);
    } catch(e){
      if(e.name === "AbortError") return;
      setPOIStatus("POI: feil.");
    }
  }
</script>
</body>
</html>
